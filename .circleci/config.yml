version: 2.1

orbs:
  newman: postman/newman@1.0.0

jobs:
  test-circleci-api:
    executor: newman/postman-newman-docker
    steps:
      - run:
          name: Create Simple Test
          command: |
            echo '{
              "info": {
                "name": "CircleCI API Demo - Basic Auth Test"
              },
              "item": [
                {
                  "name": "Verify API Authentication",
                  "request": {
                    "method": "GET",
                    "url": "https://circleci.com/api/v2/me",
                    "header": [
                      {
                        "key": "Circle-Token",
                        "value": "{{api_key_value}}"
                      }
                    ]
                  },
                  "event": [{
                    "listen": "test",
                    "script": {
                      "exec": [
                        "pm.test(\"Authentication successful\", () => {",
                        "  pm.response.to.have.status(200);",
                        "});",
                        "pm.test(\"Returns user information\", () => {",
                        "  const user = pm.response.json();",
                        "  pm.expect(user).to.have.property(\"login\");",
                        "  pm.expect(user).to.have.property(\"id\");",
                        "  console.log(\"Authenticated as: \" + user.login);",
                        "});",
                        "pm.test(\"Response time acceptable\", () => {",
                        "  pm.expect(pm.response.responseTime).to.be.below(1000);",
                        "});"
                      ]
                    }
                  }]
                }
              ]
            }' > test-collection.json
      
      - run:
          name: Create Environment
          command: |
            echo '{"values": [{"key": "api_key_value", "value": "'${CIRCLECI_API_TOKEN}'"}]}' > env.json
      
      - newman/newman-run:
          collection: test-collection.json
          environment: env.json
      
      - run:
          name: Success Message
          when: on_success
          command: echo "âœ… API Authentication test passed! The CircleCI API is working correctly."

workflows:
  test-api:
    jobs:
      - test-circleci-api:
          context: api-testing-demo